<!DOCTYPE html>

<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ProdStudy - Sistema de Estudos</title>
<link href="manifest.json" rel="manifest"/>
<!-- Fonte moderna -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&amp;display=swap" rel="stylesheet"/>
<style>/* Importa a fonte e define as vari√°veis */
:root {
  --bg: #f0f4f8;
  --text: #333;
  --primary: #3f51b5;
  --primary-dark: #303f9f;
  --accent: #ff5722;
  --card: #ffffff;
}

/* Estilos Globais */
body {
  margin: 0;
  font-family: 'Roboto', sans-serif;
  background-color: var(--bg);
  color: var(--text);
}

/* Cabe√ßalho com gradiente e espa√ßamento */
header {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  text-align: center;
  padding: 1.5rem;
  position: relative;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
header h1 {
  margin: 0.5rem 0;
  font-size: 2rem;
}
header p {
  margin: 0.5rem 0;
  font-size: 1.1rem;
}

/* Bot√µes com maior espa√ßamento entre tema e engrenagem */
.btn-theme,
.btn-gear,
.btn-task {
  background: var(--accent);
  border: none;
  cursor: pointer;
  padding: 0.6rem 1rem;
  font-size: 1rem;
  border-radius: 6px;
  color: #fff;
  transition: background 0.3s;
}
.btn-theme:hover,
.btn-gear:hover,
.btn-task:hover {
  filter: brightness(0.9);
}
.btn-gear {
  position: absolute;
  top: 10px;
  right: 120px;
}
#toggleTheme {
  position: absolute;
  top: 10px;
  right: 10px;
}

/* Menu de configura√ß√µes */
.gear-menu {
  position: absolute;
  top: 50px;
  right: 120px;
  background: var(--card);
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px;
  display: none;
  z-index: 1000;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* Navega√ß√£o */
nav {
  display: flex;
  justify-content: center;
  background: #e1e8ed;
  padding: 0.8rem;
  flex-wrap: wrap;
}
nav button {
  background: none;
  border: none;
  font-weight: 500;
  color: var(--primary);
  cursor: pointer;
  padding: 0.8rem 1rem;
  margin: 0 0.5rem;
  transition: color 0.3s, border-bottom 0.3s;
}
nav button.active {
  color: var(--primary-dark);
  border-bottom: 3px solid var(--primary-dark);
}

/* Abas */
.tab {
  display: none;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
  padding: 1rem;
}
.tab.active {
  display: block;
  opacity: 1;
  pointer-events: auto;
}

/* Cart√µes modernos */
.card {
  background: var(--card);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin: 1.5rem;
}

/* Alinhamento central */
.center {
  text-align: center;
}

/* Inputs */
input[type="text"],
input[type="date"],
input[type="time"],
input[type="number"] {
  padding: 0.7rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  width: 100%;
  box-sizing: border-box;
  margin: 0.5rem 0;
}

/* Aba Planner ‚Äì Cabe√ßalho com toggle e √°rea de adi√ß√£o */
.planner-day {
  border-bottom: 1px solid #eee;
  padding: 0.5rem 0;
}
.planner-day h3 {
  margin: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.toggle-add {
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  color: var(--accent);
}
.add-container {
  display: none;
  margin-top: 0.5rem;
  gap: 0.5rem;
  flex-wrap: wrap;
  align-items: center;
}
.add-container input {
  flex: 1;
}

/* Aba Planner ‚Äì Itens da lista com bot√µes √† direita */
.planner-task {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid #eee;
}
.planner-task span {
  flex: 1;
}
.planner-btns {
  display: flex;
  gap: 0.5rem;
}

/* Aba Notas ‚Äì Bot√µes alinhados √† direita */
.note-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  border-bottom: 1px solid #eee;
}
.note-text {
  flex: 1;
}
.note-btns {
  display: flex;
  gap: 0.5rem;
}

/* Aba Avalia√ß√µes ‚Äì Formul√°rio e itens */
.avaliacoes-form {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items: center;
  margin-bottom: 1rem;
}
.avaliacoes-form input[type="text"] {
  flex: 2;
}
.avaliacoes-form input[type="date"],
.avaliacoes-form input[type="time"] {
  flex: 1;
}
.avaliacoes-form label {
  display: flex;
  align-items: center;
  gap: 0.2rem;
}
.avaliacao-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  border-bottom: 1px solid #eee;
}
.avaliacao-details {
  flex: 1;
}
.avaliacao-btns {
  display: flex;
  gap: 0.5rem;
}

/* Kanban */
.kanban-board {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  justify-content: space-between;
}
.kanban-column {
  flex: 1;
  min-width: 250px;
  background: #f9fbfd;
  border-radius: 8px;
  padding: 0.8rem;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}
.kanban-list {
  min-height: 120px;
  border: 2px dashed #ccc;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 10px;
}
.kanban-task {
  background: var(--card);
  margin: 5px 0;
  padding: 0.8rem;
  border-radius: 6px;
  cursor: move;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
.kanban-task:hover {
  transform: scale(1.02);
}
.kanban-task-actions button {
  margin-left: 5px;
  padding: 4px 8px;
  font-size: 0.8rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.kanban-task-actions button.edit {
  background: #4caf50;
  color: #fff;
}
.kanban-task-actions button.delete {
  background: #f44336;
  color: #fff;
}

/* Calend√°rio */
#calendarContainer {
  overflow-x: auto;
}
.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.5rem;
}
.calendar-day {
  background: var(--card);
  border-radius: 8px;
  padding: 0.7rem;
  min-height: 100px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  position: relative;
}
.calendar-day h4 {
  margin: 0;
  font-size: 0.9rem;
  color: var(--primary-dark);
}

/* Tooltip */
.tooltip {
  position: absolute;
  background: var(--card);
  border: 1px solid #ccc;
  padding: 5px;
  border-radius: 6px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  z-index: 1000;
  font-size: 0.85rem;
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right:0;
  bottom:0;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}
.modal-box {
  background: var(--card);
  padding: 20px;
  border-radius: 8px;
  max-width: 90%;
  width: 300px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.modal-message {
  margin-bottom: 10px;
}
.modal-input {
  width: 100%;
  padding: 0.7rem;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

/* Dashboard responsivo */
.chart-container {
  position: relative;
  width: 100%;
  max-width: 500px;
  margin: 0 auto;
}
canvas {
  width: 100% !important;
  height: auto !important;
}

/* Dashboard ‚Äì Se√ß√£o de Avalia√ß√µes */
#avaliacoesDashboard h3 {
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
}

/* Tema escuro */
body.dark {
  --bg: #121212;
  --text: #f5f5f5;
  --card: #1e1e1e;
  background-color: var(--bg);
  color: var(--text);
}
body.dark header {
  background: #222;
}
body.dark nav button {
  color: var(--text);
}

/* Responsividade geral */
@media (max-width: 600px) {
  nav {
    flex-direction: column;
    align-items: center;
  }
  .kanban-board {
    flex-direction: column;
  }
  header h1 {
    font-size: 1.8rem;
  }
}

@media (max-width: 600px) {
  body {
    font-size: 16px;
    padding: 0 10px;
  }
  header h1 {
    font-size: 1.5rem;
  }
  header p {
    font-size: 1rem;
  }
  
  nav {
    flex-direction: column;
  }
  .tab {
    padding: 0.5rem;
  }
  .kanban-board {
    flex-direction: column;
  }
  .kanban-column {
    width: 100%;
  }
  .calendar-day {
    min-height: 80px;
  }
  .chart-container {
    max-width: 100%;
  }
}

@media (max-width: 600px) {
  .tab .btn-task {
    font-size: 1rem;
    padding: 0.8rem;
    width: 100%;
    margin-bottom: 0.5rem;
  }
}
</style>
<!-- Inclus√£o do Chart.js para o Dashboard -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
<button class="btn-theme" id="toggleTheme">üåì Tema</button>
<button class="btn-gear" id="gearButton">‚öôÔ∏è</button>
<div class="gear-menu" id="gearMenu">
<button class="btn-task" onclick="exportData()">Exportar Dados (JSON)</button>
<button class="btn-task" onclick="document.getElementById('importInput').click()">Importar Dados (JSON)</button>
<input accept=".json" id="importInput" style="display:none;" type="file"/>
</div>
<h1>ProdStudy</h1>
<p>Seu sistema pessoal de organiza√ß√£o de estudos</p>
</header>
<nav>
<!-- Bot√µes de navega√ß√£o -->
<button aria-controls="planner" aria-selected="true" class="tab-btn active" data-tab="planner" role="tab">Planner</button>
<button aria-controls="kanban" aria-selected="false" class="tab-btn" data-tab="kanban" role="tab">Kanban</button>
<button aria-controls="pomodoro" aria-selected="false" class="tab-btn" data-tab="pomodoro" role="tab">Pomodoro</button>
<button aria-controls="notas" aria-selected="false" class="tab-btn" data-tab="notas" role="tab">Notas</button>
<button aria-controls="dashboard" aria-selected="false" class="tab-btn" data-tab="dashboard" role="tab">Dashboard</button>
<button aria-controls="calendario" aria-selected="false" class="tab-btn" data-tab="calendario" role="tab">Calend√°rio</button>
<button aria-controls="avaliacoes" aria-selected="false" class="tab-btn" data-tab="avaliacoes" role="tab">Avalia√ß√µes</button>
</nav>
<!-- Aba Planner -->
<div class="tab active" id="planner">
<div class="card">
<h2>Planejador Semanal</h2>
<div id="plannerContainer"></div>
</div>
</div>
<!-- Aba Kanban -->
<div class="tab" id="kanban">
<div class="card">
<h2>Quadro Kanban</h2>
<div class="center" id="kanbanDateControls">
<button class="btn-task" onclick="prevKanbanDate()">Data Anterior</button>
<span id="kanbanDateDisplay"></span>
<button class="btn-task" onclick="nextKanbanDate()">Pr√≥xima Data</button>
</div>
<div class="kanban-board">
<div class="kanban-column" id="todoColumn">
<h3>A Fazer</h3>
<div class="kanban-list" id="todo"></div>
<input id="todoInput" placeholder="Nova tarefa" type="text"/>
<button class="btn-task" onclick="addKanbanTask('todo')">Adicionar</button>
</div>
<div class="kanban-column" id="doingColumn">
<h3>Em Progresso</h3>
<div class="kanban-list" id="doing"></div>
<input id="doingInput" placeholder="Nova tarefa" type="text"/>
<button class="btn-task" onclick="addKanbanTask('doing')">Adicionar</button>
</div>
<div class="kanban-column" id="doneColumn">
<h3>Conclu√≠do</h3>
<div class="kanban-list" id="done"></div>
<input id="doneInput" placeholder="Nova tarefa" type="text"/>
<button class="btn-task" onclick="addKanbanTask('done')">Adicionar</button>
</div>
</div>
</div>
</div>
<!-- Aba Pomodoro -->
<div class="tab" id="pomodoro">
<div class="card">
<h2>Pomodoro</h2>
<div class="center">
<div id="sessionCounter">Sess√µes completas: <span id="sessionCount">0</span></div>
<div id="timerDisplay">00:00</div>
<button class="btn-task" onclick="startPomodoro()">Iniciar</button>
<button class="btn-task" onclick="pausePomodoro()">Pausar</button>
<button class="btn-task" onclick="addTimePomodoro()">Adicionar Tempo</button>
<button class="btn-task" onclick="resetPomodoro()">Redefinir</button>
</div>
</div>
</div>
<!-- Aba Notas -->
<div class="tab" id="notas">
<div class="card">
<h2>Notas R√°pidas</h2>
<div class="center">
<button class="btn-task" onclick="toggleNotes()">Mostrar Notas</button>
</div>
<div id="notesSection">
<input id="noteInput" placeholder="Digite sua nota e pressione Enter" type="text"/>
<div id="notesList"></div>
</div>
</div>
</div>
<!-- Aba Dashboard -->
<div class="tab" id="dashboard">
<div class="card">
<h2>Dashboard</h2>
<div class="center">
<label>Data: <input id="dashboardDate" onchange="updateDashboardCharts();" type="date"/></label>
</div>
<div class="chart-container" id="kanbanChartContainer">
<canvas id="progressChart"></canvas>
</div>
<div class="chart-container" id="avaliacoesChartContainer">
<canvas id="avaliacoesChart"></canvas>
</div>
</div>
</div>
<!-- Aba Calend√°rio -->
<div class="tab" id="calendario">
<div class="card">
<h2>Calend√°rio</h2>
<div id="calendarContainer"></div>
</div>
</div>
<!-- Aba Avalia√ß√µes -->
<div class="tab" id="avaliacoes">
<div class="card">
<h2>Avalia√ß√µes e Entregas</h2>
<div class="avaliacoes-form">
<input id="avaliacaoDesc" placeholder="Descri√ß√£o" type="text"/>
<input id="avaliacaoDate" style="max-width:120px;" type="date"/>
<input id="avaliacaoTime" style="max-width:100px;" type="time"/>
<label>
<input id="avaliacaoProva" type="checkbox"/>
          Prova (desmarcado = Trabalho)
        </label>
<button class="btn-task" onclick="addAvaliacao()">Agendar Avalia√ß√£o</button>
</div>
<!-- Bot√£o para exibir/ocultar os agendamentos -->
<button class="btn-task" id="toggleAvaliacoes">Mostrar Agendamentos por Data</button>
<!-- Lista de avalia√ß√µes inicialmente oculta -->
<div id="avaliacoesList" style="display: none;"></div>
</div>
</div>
<!-- Modal para mensagens, confirma√ß√µes e prompts -->
<div aria-hidden="true" class="modal-overlay" id="modalOverlay">
<div aria-modal="true" class="modal-box" id="modalBox" role="dialog">
<div class="modal-message" id="modalMessage"></div>
<input class="modal-input" id="modalInput" style="display:none;" type="text"/>
<div class="modal-buttons">
<button class="btn-task" id="modalOk">OK</button>
<button class="btn-task" id="modalCancel" style="display:none;">Cancelar</button>
</div>
</div>
</div>
<script>/* script.js */

// Inicializa√ß√µes ap√≥s o carregamento do DOM
document.addEventListener('DOMContentLoaded', function(){
  initTabs();
  initGearMenu();
  initTheme();
  initNotesInput();
  initKanbanDropEvents();
  updateKanbanDateDisplay();
  renderPlanner();
  renderNotes();
  renderCalendar();
  // Como as avalia√ß√µes agora ficam ocultas por padr√£o, o renderAvaliacoes() ser√° chamado
  // somente quando o usu√°rio clicar no bot√£o de toggle.
  renderAvaliacoesDashboard();
  
  // Registra o evento de clique do bot√£o de tema (se n√£o estiver definido inline)
  document.getElementById("toggleTheme").addEventListener("click", toggleTheme);
  
  // Configura o bot√£o para exibir/ocultar agendamentos na aba Avalia√ß√µes
  document.getElementById("toggleAvaliacoes").addEventListener("click", function(){
    const avaliacoesList = document.getElementById("avaliacoesList");
    if(avaliacoesList.style.display === "none" || avaliacoesList.style.display === ""){
      avaliacoesList.style.display = "block";
      this.textContent = "Ocultar Agendamentos";
      renderAvaliacoes();
    } else {
      avaliacoesList.style.display = "none";
      this.textContent = "Mostrar Agendamentos por Data";
    }
  });
  
  // Atualiza o display do Pomodoro (inicia zerado)
  updatePomodoroDisplay();
});

/* Fun√ß√µes de inicializa√ß√£o */
function initTabs(){
  document.querySelectorAll('.tab-btn').forEach(button => {
    button.addEventListener('click', () => {
      const tabToShow = button.getAttribute('data-tab');
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.setAttribute('aria-selected', 'false');
      });
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      button.classList.add('active');
      button.setAttribute('aria-selected', 'true');
      document.getElementById(tabToShow).classList.add('active');
    });
  });
}

function initGearMenu(){
  const gearButton = document.getElementById("gearButton");
  const gearMenu = document.getElementById("gearMenu");
  gearButton.addEventListener("click", function(){
    gearMenu.style.display = gearMenu.style.display === "block" ? "none" : "block";
  });
}

function initTheme(){
  const currentTheme = localStorage.getItem("theme");
  if(currentTheme === "dark"){
    document.body.classList.add("dark");
  }
}

function initNotesInput(){
  const noteInput = document.getElementById("noteInput");
  noteInput.addEventListener("keypress", e => {
    if(e.key === "Enter" && noteInput.value.trim() !== ""){
      const notes = loadNotes();
      notes.push(noteInput.value.trim());
      saveNotes(notes);
      noteInput.value = "";
      renderNotes();
      renderCalendar();
    }
  });
}

/* Fun√ß√µes de Modal (substituindo alert, confirm e prompt) */
function showModal({message, defaultValue = "", showInput = false, showCancel = false}) {
  return new Promise((resolve) => {
    const modalOverlay = document.getElementById("modalOverlay");
    const modalMessage = document.getElementById("modalMessage");
    const modalInput = document.getElementById("modalInput");
    const modalOk = document.getElementById("modalOk");
    const modalCancel = document.getElementById("modalCancel");
    
    modalMessage.textContent = message;
    if(showInput) {
      modalInput.value = defaultValue;
      modalInput.style.display = "block";
    } else {
      modalInput.style.display = "none";
    }
    modalCancel.style.display = showCancel ? "inline-block" : "none";
    
    modalOverlay.style.display = "flex";
    modalOverlay.setAttribute("aria-hidden", "false");
    if(showInput) modalInput.focus();
    
    function cleanup(){
      modalOverlay.style.display = "none";
      modalOverlay.setAttribute("aria-hidden", "true");
      modalOk.removeEventListener("click", onOk);
      modalCancel.removeEventListener("click", onCancel);
    }
    
    function onOk(){
      const result = showInput ? modalInput.value : true;
      cleanup();
      resolve(result);
    }
    
    function onCancel(){
      cleanup();
      resolve(null);
    }
    
    modalOk.addEventListener("click", onOk);
    if(showCancel){
      modalCancel.addEventListener("click", onCancel);
    }
  });
}

function customAlert(message){
  return showModal({message});
}

function customConfirm(message){
  return showModal({message, showCancel: true});
}

function customPrompt(message, defaultValue = ""){
  return showModal({message, defaultValue, showInput: true, showCancel: true});
}

/* --------------------- Kanban --------------------- */
let currentKanbanDate = new Date();
function updateKanbanDateDisplay() {
  document.getElementById("kanbanDateDisplay").textContent = currentKanbanDate.toLocaleDateString('pt-BR');
  renderKanban();
}
function prevKanbanDate() {
  currentKanbanDate.setDate(currentKanbanDate.getDate() - 1);
  updateKanbanDateDisplay();
}
function nextKanbanDate() {
  currentKanbanDate.setDate(currentKanbanDate.getDate() + 1);
  updateKanbanDateDisplay();
}
function getKanbanKey(column) {
  const dateStr = currentKanbanDate.toISOString().slice(0,10);
  return "kanban_" + dateStr + "_" + column;
}
function loadKanban(column) {
  return JSON.parse(localStorage.getItem(getKanbanKey(column))) || [];
}
function saveKanban(column, tasks) {
  localStorage.setItem(getKanbanKey(column), JSON.stringify(tasks));
}
function addKanbanTask(column) {
  const input = document.getElementById(column + 'Input');
  const value = input.value.trim();
  if(value){
    const tasks = loadKanban(column);
    tasks.push(value);
    saveKanban(column, tasks);
    renderKanban();
    input.value = "";
  }
}
async function editKanbanTask(column, index) {
  const tasks = loadKanban(column);
  const newText = await customPrompt("Editar tarefa", tasks[index]);
  if(newText && newText.trim() !== ""){
    tasks[index] = newText.trim();
    saveKanban(column, tasks);
    renderKanban();
  }
}
async function deleteKanbanTask(column, index) {
  const tasks = loadKanban(column);
  const confirmed = await customConfirm("Tem certeza que deseja apagar essa tarefa?");
  if(confirmed){
    tasks.splice(index, 1);
    saveKanban(column, tasks);
    renderKanban();
  }
}
function renderKanban() {
  ['todo','doing','done'].forEach(col => {
    const container = document.getElementById(col);
    const input = document.getElementById(col + 'Input');
    container.innerHTML = "";
    const tasks = loadKanban(col);
    tasks.forEach((t, index) => {
      const task = document.createElement('div');
      task.className = "kanban-task";
      task.textContent = t;
      const actions = document.createElement("div");
      actions.className = "kanban-task-actions";
      const editBtn = document.createElement("button");
      editBtn.textContent = "Editar";
      editBtn.className = "edit";
      editBtn.onclick = (e) => { e.stopPropagation(); editKanbanTask(col, index); };
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Apagar";
      deleteBtn.className = "delete";
      deleteBtn.onclick = (e) => { e.stopPropagation(); deleteKanbanTask(col, index); };
      actions.appendChild(editBtn);
      actions.appendChild(deleteBtn);
      task.appendChild(actions);
      task.draggable = true;
      task.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', JSON.stringify({value: t, from: col}));
        e.stopPropagation();
      });
      task.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); });
      task.addEventListener('drop', e => {
        e.preventDefault();
        e.stopPropagation();
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        if(data.from === col){
          let colTasks = loadKanban(col);
          const fromIndex = colTasks.indexOf(data.value);
          if(fromIndex > -1) colTasks.splice(fromIndex, 1);
          colTasks.splice(index, 0, data.value);
          saveKanban(col, colTasks);
        } else {
          let fromTasks = loadKanban(data.from);
          let toTasks = loadKanban(col);
          fromTasks = fromTasks.filter(item => item !== data.value);
          toTasks.splice(index, 0, data.value);
          saveKanban(data.from, fromTasks);
          saveKanban(col, toTasks);
        }
        renderKanban();
      });
      container.appendChild(task);
    });
    input.value = "";
  });
}
function initKanbanDropEvents() {
  ['todo', 'doing', 'done'].forEach(col => {
    const container = document.getElementById(col);
    container.addEventListener('dragover', e => { e.preventDefault(); });
    container.addEventListener('drop', e => {
      e.preventDefault();
      if(e.target === container) {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        if(data.from === col){
          let colTasks = loadKanban(col);
          const fromIndex = colTasks.indexOf(data.value);
          if(fromIndex > -1) colTasks.splice(fromIndex, 1);
          colTasks.push(data.value);
          saveKanban(col, colTasks);
        } else {
          let fromTasks = loadKanban(data.from);
          let toTasks = loadKanban(col);
          fromTasks = fromTasks.filter(item => item !== data.value);
          toTasks.push(data.value);
          saveKanban(data.from, fromTasks);
          saveKanban(col, toTasks);
        }
        renderKanban();
      }
    });
  });
}

/* --------------------- Planner --------------------- */
let currentWeekOffset = 0;
function getWeekDates(offset) {
  const now = new Date();
  const dayOfWeek = now.getDay();
  const sunday = new Date(now);
  sunday.setDate(now.getDate() - dayOfWeek + (offset * 7));
  let dates = [];
  for (let i = 0; i < 7; i++) {
    let d = new Date(sunday);
    d.setDate(sunday.getDate() + i);
    dates.push(d);
  }
  return dates;
}
function loadDayTasks(key) {
  return JSON.parse(localStorage.getItem(key)) || [];
}
function saveDayTasks(key, tasks) {
  localStorage.setItem(key, JSON.stringify(tasks));
}
function renderPlanner() {
  const container = document.getElementById('plannerContainer');
  container.innerHTML = "";
  const navDiv = document.createElement('div');
  navDiv.style.display = "flex";
  navDiv.style.justifyContent = "space-between";
  const prevBtn = document.createElement('button');
  prevBtn.textContent = "Semana Anterior";
  prevBtn.className = "btn-task";
  prevBtn.onclick = () => { currentWeekOffset--; renderPlanner(); };
  const nextBtn = document.createElement('button');
  nextBtn.textContent = "Pr√≥xima Semana";
  nextBtn.className = "btn-task";
  nextBtn.onclick = () => { currentWeekOffset++; renderPlanner(); };
  navDiv.appendChild(prevBtn);
  navDiv.appendChild(nextBtn);
  container.appendChild(navDiv);
  
  const weekDates = getWeekDates(currentWeekOffset);
  weekDates.forEach(date => {
    const key = "planner_" + date.toISOString().slice(0,10);
    let tasks = loadDayTasks(key);
    
    const section = document.createElement('div');
    section.className = "planner-day";
    
    const headerDiv = document.createElement("div");
    headerDiv.style.display = "flex";
    headerDiv.style.justifyContent = "space-between";
    headerDiv.style.alignItems = "center";
    
    const title = document.createElement('h3');
    const options = { weekday: 'long', day: 'numeric', month: 'numeric' };
    title.textContent = date.toLocaleDateString('pt-BR', options);
    
    const toggleBtn = document.createElement("button");
    toggleBtn.className = "toggle-add";
    toggleBtn.textContent = "‚ñº";
    const addContainer = document.createElement("div");
    addContainer.className = "add-container";
    addContainer.style.display = "none";
    
    toggleBtn.addEventListener("click", function(){
      if(addContainer.style.display === "none"){
        addContainer.style.display = "flex";
        toggleBtn.textContent = "‚ñ≤";
      } else {
        addContainer.style.display = "none";
        toggleBtn.textContent = "‚ñº";
      }
    });
    
    headerDiv.appendChild(title);
    headerDiv.appendChild(toggleBtn);
    section.appendChild(headerDiv);
    
    const input = document.createElement('input');
    input.placeholder = `Adicionar tarefa para ${title.textContent}`;
    input.type = "text";
    const addBtn = document.createElement('button');
    addBtn.textContent = "Adicionar";
    addBtn.className = "btn-task";
    addBtn.onclick = () => {
      if(input.value.trim() !== ""){
        tasks.push(input.value.trim());
        saveDayTasks(key, tasks);
        renderPlanner();
      }
    };
    
    addContainer.appendChild(input);
    addContainer.appendChild(addBtn);
    section.appendChild(addContainer);
    
    const list = document.createElement('div');
    list.className = "task-list";
    tasks.forEach((t, index) => {
      const taskDiv = document.createElement('div');
      taskDiv.className = "planner-task";
      const span = document.createElement('span');
      span.textContent = t;
      const btnContainer = document.createElement('div');
      btnContainer.className = "planner-btns";
      const editBtn = document.createElement('button');
      editBtn.textContent = "Editar";
      editBtn.className = "btn-task";
      editBtn.onclick = async () => {
        const newText = await customPrompt("Editar tarefa", t);
        if(newText && newText.trim() !== ""){
          tasks[index] = newText.trim();
          saveDayTasks(key, tasks);
          renderPlanner();
        }
      };
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = "Apagar";
      deleteBtn.className = "btn-task";
      deleteBtn.onclick = async () => {
        const confirmed = await customConfirm("Tem certeza que deseja apagar essa tarefa?");
        if(confirmed){
          tasks.splice(index, 1);
          saveDayTasks(key, tasks);
          renderPlanner();
        }
      };
      btnContainer.appendChild(editBtn);
      btnContainer.appendChild(deleteBtn);
      taskDiv.appendChild(span);
      taskDiv.appendChild(btnContainer);
      list.appendChild(taskDiv);
    });
    section.appendChild(list);
    container.appendChild(section);
  });
}

/* --------------------- Notas --------------------- */
function loadNotes() {
  return JSON.parse(localStorage.getItem("quick_notes")) || [];
}
function saveNotes(notes) {
  localStorage.setItem("quick_notes", JSON.stringify(notes));
}
function renderNotes() {
  const notes = loadNotes();
  const notesList = document.getElementById("notesList");
  notesList.innerHTML = "";
  notes.forEach((note, index) => {
    const noteDiv = document.createElement("div");
    noteDiv.className = "note-item";
    noteDiv.innerHTML = `
      <span class="note-text">${note}</span>
      <div class="note-btns">
        <button onclick="editNote(${index})" class="btn-task">Editar</button>
        <button onclick="deleteNote(${index})" class="btn-task">Apagar</button>
      </div>
    `;
    notesList.appendChild(noteDiv);
  });
}
async function deleteNote(index) {
  const notes = loadNotes();
  const confirmed = await customConfirm("Tem certeza que deseja apagar essa nota?");
  if(confirmed){
    notes.splice(index, 1);
    saveNotes(notes);
    renderNotes();
    renderCalendar();
  }
}
async function editNote(index) {
  const notes = loadNotes();
  const newText = await customPrompt("Editar nota", notes[index]);
  if(newText && newText.trim() !== ""){
    notes[index] = newText.trim();
    saveNotes(notes);
    renderNotes();
    renderCalendar();
  }
}
function toggleNotes() {
  const notesList = document.getElementById("notesList");
  const btn = document.querySelector("#notas .btn-task");
  if(notesList.style.display === "none" || notesList.style.display === ""){
    notesList.style.display = "block";
    btn.textContent = "Ocultar Notas";
  } else {
    notesList.style.display = "none";
    btn.textContent = "Mostrar Notas";
  }
}

/* --------------------- Pomodoro --------------------- */
let pomodoroTime = 0; // Tempo inicia zerado
let pomodoroInterval;
let pomodoroSessions = 0;
function startPomodoro() {
  if(pomodoroTime <= 0) {
    customAlert("Por favor, adicione tempo antes de iniciar o Pomodoro.");
    return;
  }
  clearInterval(pomodoroInterval);
  pomodoroInterval = setInterval(() => {
    if(pomodoroTime > 0) {
      pomodoroTime--;
      updatePomodoroDisplay();
    } else {
      clearInterval(pomodoroInterval);
      playBeep();
      pomodoroSessions++;
      document.getElementById("sessionCount").textContent = pomodoroSessions;
      customAlert("Tempo encerrado! Fa√ßa uma pausa.");
    }
  }, 1000);
}
function pausePomodoro() {
  clearInterval(pomodoroInterval);
}
function addTimePomodoro() {
  customPrompt("Quantos minutos deseja adicionar?", "0").then(result => {
    const minutes = parseInt(result);
    if(!isNaN(minutes)){
      pomodoroTime += minutes * 60;
      updatePomodoroDisplay();
    }
  });
}
function resetPomodoro() {
  clearInterval(pomodoroInterval);
  pomodoroTime = 0;
  updatePomodoroDisplay();
}
function updatePomodoroDisplay() {
  const minutes = String(Math.floor(pomodoroTime / 60)).padStart(2, '0');
  const seconds = String(pomodoroTime % 60).padStart(2, '0');
  document.getElementById('timerDisplay').textContent = `${minutes}:${seconds}`;
}
function playBeep() {
  const audio = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQgAAAAA");
  audio.play();
}

/* --------------------- Dashboard --------------------- */
function getDashboardDate() {
  const input = document.getElementById("dashboardDate");
  if(input && input.value){
    return input.value;
  }
  return new Date().toISOString().slice(0,10);
}
function getKanbanStatsForDate() {
  const dateStr = getDashboardDate();
  const stats = ['todo','doing','done'].map(col => {
    const key = "kanban_" + dateStr + "_" + col;
    const tasks = JSON.parse(localStorage.getItem(key)) || [];
    return tasks.length;
  });
  return stats;
}
function renderProgressChart() {
  const canvas = document.getElementById("progressChart");
  const stats = getKanbanStatsForDate();
  const labels = ["A Fazer", "Em Progresso", "Conclu√≠do"];
  const colors = ["#3f51b5", "#ff9800", "#4caf50"];
  if(kanbanChart) {
    kanbanChart.data.datasets[0].data = stats;
    kanbanChart.update();
  } else {
    const ctx = canvas.getContext("2d");
    kanbanChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: stats,
          backgroundColor: colors
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
}
let kanbanChart = null;
let avaliacoesChart = null;
function renderAvaliacoesDashboard() {
  renderAvaliacoesChart();
}
function renderAvaliacoesChart() {
  const canvas = document.getElementById("avaliacoesChart");
  const avaliacoes = loadAvaliacoes();
  const counts = { "Conclu√≠da": 0, "Ausente": 0, "Pendente": 0 };
  avaliacoes.forEach(a => {
    const st = a.status || "Pendente";
    counts[st] = (counts[st] || 0) + 1;
  });
  const labels = Object.keys(counts);
  const data = Object.values(counts);
  const colors = ["#4caf50", "#f44336", "#ff9800"];
  if(avaliacoesChart) {
    avaliacoesChart.data.datasets[0].data = data;
    avaliacoesChart.data.labels = labels;
    avaliacoesChart.update();
  } else {
    const ctx = canvas.getContext("2d");
    avaliacoesChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: colors
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
}
function updateDashboardCharts(){
  renderProgressChart();
  renderAvaliacoesDashboard();
}

/* --------------------- Calend√°rio --------------------- */
function renderCalendar() {
  const container = document.getElementById("calendarContainer");
  container.innerHTML = "";
  const headerDiv = document.createElement("div");
  headerDiv.style.display = "flex";
  headerDiv.style.justifyContent = "space-between";
  headerDiv.style.alignItems = "center";
  const prevMonthBtn = document.createElement("button");
  prevMonthBtn.className = "btn-task";
  prevMonthBtn.textContent = "M√™s Anterior";
  prevMonthBtn.onclick = () => {
    if(calendarMonth === 0) {
      calendarMonth = 11;
      calendarYear--;
    } else {
      calendarMonth--;
    }
    renderCalendar();
  };
  const nextMonthBtn = document.createElement("button");
  nextMonthBtn.className = "btn-task";
  nextMonthBtn.textContent = "Pr√≥ximo M√™s";
  nextMonthBtn.onclick = () => {
    if(calendarMonth === 11) {
      calendarMonth = 0;
      calendarYear++;
    } else {
      calendarMonth++;
    }
    renderCalendar();
  };
  const monthYearLabel = document.createElement("div");
  monthYearLabel.textContent = new Date(calendarYear, calendarMonth).toLocaleString("pt-BR", {month:"long", year:"numeric"});
  headerDiv.appendChild(prevMonthBtn);
  headerDiv.appendChild(monthYearLabel);
  headerDiv.appendChild(nextMonthBtn);
  container.appendChild(headerDiv);
  
  const grid = document.createElement("div");
  grid.className = "calendar";
  const headers = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
  headers.forEach(day => {
    const cell = document.createElement("div");
    cell.style.fontWeight = "bold";
    cell.textContent = day;
    grid.appendChild(cell);
  });
  const firstDay = new Date(calendarYear, calendarMonth, 1);
  const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
  const numDays = lastDay.getDate();
  for(let i = 0; i < firstDay.getDay(); i++){
    const emptyCell = document.createElement("div");
    grid.appendChild(emptyCell);
  }
  for(let d = 1; d <= numDays; d++){
    const cell = document.createElement("div");
    cell.className = "calendar-day";
    const currentDate = new Date(calendarYear, calendarMonth, d);
    const isoDate = currentDate.toISOString().slice(0,10);
    const dayHeader = document.createElement("h4");
    dayHeader.textContent = d;
    cell.appendChild(dayHeader);
    // Exibe tarefas do Planner (de forma similar √†s avalia√ß√µes)
    const tasks = JSON.parse(localStorage.getItem("planner_" + isoDate)) || [];
    if(tasks.length > 0) {
      const tasksDiv = document.createElement("div");
      tasksDiv.textContent = "Tarefas: " + tasks.length;
      tasksDiv.style.fontSize = "0.8rem";
      tasksDiv.style.color = "var(--primary-dark)";
      tasksDiv.style.cursor = "pointer";
      tasksDiv.addEventListener("mouseover", (e) => {
        showTooltip(e, tasks);
      });
      tasksDiv.addEventListener("mouseout", hideTooltip);
      cell.appendChild(tasksDiv);
    }
    // Exibe avalia√ß√µes do dia
    const avaliacoesDoDia = loadAvaliacoes().filter(e => e.date === isoDate);
    if(avaliacoesDoDia.length > 0) {
      const avalDiv = document.createElement("div");
      avalDiv.textContent = "Avalia√ß√µes: " + avaliacoesDoDia.length;
      avalDiv.style.fontSize = "0.8rem";
      avalDiv.style.color = "var(--accent)";
      avalDiv.style.cursor = "pointer";
      avalDiv.addEventListener("mouseover", (e) => {
        showTooltip(e, avaliacoesDoDia.map(a => `${a.time} - ${a.tipo}: ${a.description} - Nota: ${a.nota || "Sem nota"} - ${a.status}`));
      });
      avalDiv.addEventListener("mouseout", hideTooltip);
      cell.appendChild(avalDiv);
    }
    grid.appendChild(cell);
  }
  container.appendChild(grid);
}
let calendarYear = new Date().getFullYear();
let calendarMonth = new Date().getMonth();

/* --------------------- Avalia√ß√µes --------------------- */
function loadAvaliacoes() {
  return JSON.parse(localStorage.getItem("avaliacoes")) || [];
}
function saveAvaliacoes(data) {
  localStorage.setItem("avaliacoes", JSON.stringify(data));
}
function addAvaliacao() {
  const desc = document.getElementById("avaliacaoDesc").value.trim();
  const date = document.getElementById("avaliacaoDate").value;
  const time = document.getElementById("avaliacaoTime").value;
  const provaChecked = document.getElementById("avaliacaoProva").checked;
  const tipo = provaChecked ? "Prova" : "Trabalho";
  if(desc && date && time) {
    const avaliacoes = loadAvaliacoes();
    const nova = {
      id: Date.now(),
      description: desc,
      date: date,
      time: time,
      tipo: tipo,
      nota: "",
      status: "Pendente"
    };
    avaliacoes.push(nova);
    saveAvaliacoes(avaliacoes);
    renderAvaliacoes();
    renderAvaliacoesDashboard();
    renderCalendar();
    document.getElementById("avaliacaoDesc").value = "";
    document.getElementById("avaliacaoDate").value = "";
    document.getElementById("avaliacaoTime").value = "";
    document.getElementById("avaliacaoProva").checked = false;
  } else {
    customAlert("Descri√ß√£o, data e hora s√£o obrigat√≥rios.");
  }
}
function renderAvaliacoes() {
  const container = document.getElementById("avaliacoesList");
  container.innerHTML = "";
  const avaliacoes = loadAvaliacoes();
  // Agrupa avalia√ß√µes por m√™s (YYYY-MM)
  const grupos = {};
  avaliacoes.forEach(aval => {
    const mes = aval.date.substring(0,7);
    if(!grupos[mes]) {
      grupos[mes] = [];
    }
    grupos[mes].push(aval);
  });
  for(let mes in grupos) {
    const mesDiv = document.createElement("div");
    mesDiv.className = "avaliacao-mes";
    const mesTitulo = document.createElement("h3");
    mesTitulo.textContent = mes;
    mesDiv.appendChild(mesTitulo);
    grupos[mes].forEach((aval, index) => {
      const itemDiv = document.createElement("div");
      itemDiv.className = "avaliacao-item";
      itemDiv.innerHTML = `
        <div class="avaliacao-details">
          <strong>${aval.date} ${aval.time}</strong> - ${aval.tipo}: ${aval.description} - Nota: ${aval.nota ? aval.nota : "Sem nota"} - ${aval.status}
        </div>
        <div class="avaliacao-btns">
          <button class="btn-task" onclick="inserirNota(${index})">Inserir Nota</button>
          <button class="btn-task" onclick="marcarStatus(${index}, 'Conclu√≠da')">Conclu√≠da</button>
          <button class="btn-task" onclick="marcarStatus(${index}, 'Ausente')">Ausente</button>
          <button class="btn-task" onclick="editAvaliacao(${index})">Editar</button>
          <button class="btn-task" onclick="deleteAvaliacao(${index})">Apagar</button>
        </div>
      `;
      itemDiv.style.display = "flex";
      itemDiv.style.justifyContent = "space-between";
      mesDiv.appendChild(itemDiv);
    });
    container.appendChild(mesDiv);
  }
}
async function editAvaliacao(index) {
  const avaliacoes = loadAvaliacoes();
  const aval = avaliacoes[index];
  const newDesc = await customPrompt("Editar Descri√ß√£o", aval.description);
  const newDate = await customPrompt("Editar Data (YYYY-MM-DD)", aval.date);
  const newTime = await customPrompt("Editar Hora (HH:MM)", aval.time);
  const newTipo = await customConfirm("Marcar como Prova? (OK = Sim, Cancelar = Trabalho)") ? "Prova" : "Trabalho";
  if(newDesc && newDate && newTime) {
    avaliacoes[index] = {
      ...aval,
      description: newDesc.trim(),
      date: newDate.trim(),
      time: newTime.trim(),
      tipo: newTipo,
    };
    saveAvaliacoes(avaliacoes);
    renderAvaliacoes();
    renderAvaliacoesDashboard();
    renderCalendar();
  }
}
async function deleteAvaliacao(index) {
  const avaliacoes = loadAvaliacoes();
  const confirmed = await customConfirm("Tem certeza que deseja apagar essa avalia√ß√£o?");
  if(confirmed){
    avaliacoes.splice(index, 1);
    saveAvaliacoes(avaliacoes);
    renderAvaliacoes();
    renderAvaliacoesDashboard();
    renderCalendar();
  }
}
async function inserirNota(index) {
  const avaliacoes = loadAvaliacoes();
  const aval = avaliacoes[index];
  const nota = await customPrompt("Inserir Nota", aval.nota);
  if(nota !== null){
    aval.nota = nota.trim();
    saveAvaliacoes(avaliacoes);
    renderAvaliacoes();
    renderAvaliacoesDashboard();
    renderCalendar();
  }
}
async function marcarStatus(index, status) {
  const avaliacoes = loadAvaliacoes();
  avaliacoes[index].status = status;
  saveAvaliacoes(avaliacoes);
  renderAvaliacoes();
  renderAvaliacoesDashboard();
  renderCalendar();
}

/* --------------------- Exportar / Importar Dados --------------------- */
function exportData() {
  const data = {};
  for(let key in localStorage) {
    if(key.startsWith("planner_") || key.startsWith("kanban_") || key === "quick_notes" || key === "avaliacoes"){
      data[key] = JSON.parse(localStorage.getItem(key));
    }
  }
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "prodstudy_dados.json";
  a.click();
  URL.revokeObjectURL(url);
}
document.getElementById("importInput").onchange = function(e) {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      Object.keys(data).forEach(key => localStorage.setItem(key, JSON.stringify(data[key])));
      customAlert("Dados importados com sucesso! Recarregue a p√°gina para aplicar.");
    } catch {
      customAlert("Erro ao importar dados. Verifique o arquivo.");
    }
  };
  reader.readAsText(file);
};

/* --------------------- Alternar Tema --------------------- */
function toggleTheme() {
  document.body.classList.toggle("dark");
  localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
}

/* --------------------- Tooltip --------------------- */
function showTooltip(e, items) {
  hideTooltip();
  tooltipElement = document.createElement("div");
  tooltipElement.className = "tooltip";
  items.forEach(item => {
    const badge = document.createElement("div");
    badge.textContent = item;
    badge.style.background = "#ff5722";
    badge.style.color = "#fff";
    badge.style.padding = "2px 5px";
    badge.style.margin = "2px 0";
    badge.style.borderRadius = "4px";
    tooltipElement.appendChild(badge);
  });
  document.body.appendChild(tooltipElement);
  const rect = e.target.getBoundingClientRect();
  tooltipElement.style.left = rect.left + "px";
  tooltipElement.style.top = (rect.bottom + window.scrollY) + "px";
}
function hideTooltip() {
  if (tooltipElement) {
    tooltipElement.parentNode.removeChild(tooltipElement);
    tooltipElement = null;
  }
}
let tooltipElement = null;
</script>
<script>
    // Registra o Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js').then(() => {
          console.log('Service Worker registrado!');
        });
      });
    }
  </script>
<script id="service-worker-script" type="text/plain">const CACHE_NAME = 'prodstudy-cache-v2';
const urlsToCache = [
  './ProdStudy.html',
  './style.css',
  './script.js',
  './manifest.json',
  './service-worker.js',
  'https://cdn.jsdelivr.net/npm/chart.js'
];

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(urlsToCache))
  );
  self.skipWaiting();
});

self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(keys => {
      return Promise.all(
        keys.filter(key => key !== CACHE_NAME)
            .map(key => caches.delete(key))
      );
    })
  );
  self.clients.claim();
});

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => {
        return response || fetch(event.request)
          .then(fetchResponse => {
            return caches.open(CACHE_NAME)
              .then(cache => {
                if (event.request.method === 'GET') {
                  cache.put(event.request, fetchResponse.clone());
                }
                return fetchResponse;
              });
          });
      })
  );
});
</script></body>
</html>
